<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sport Rays Admin</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; background: #0b0b0b; color: #eee; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, textarea, button, select { padding: 8px; border-radius: 6px; border: 1px solid #333; background: #111; color: #eee; }
    button { cursor: pointer; background: #1f6feb; border: none; }
    button.secondary { background: #333; }
    .card { border: 1px solid #222; border-radius: 8px; padding: 12px; margin: 12px 0; }
    .muted { opacity: .8; }
    .list { margin-top: 16px; }
    .col { display: flex; flex-direction: column; gap: 8px; }
    .danger { background: #b42318; }
  </style>
</head>
<body>
  <h1>Sport Rays Admin</h1>
  <div class="row">
    <label for="secret">Admin Secret:</label>
    <input id="secret" type="password" placeholder="Enter ADMIN_SECRET" required />
    <button id="load">Load Polls</button>
    <button id="testConnection" class="secondary">Test Connection</button>
  </div>
  <div id="status" style="margin: 10px 0; padding: 8px; border-radius: 4px; display: none;"></div>

  <h2>Create Poll</h2>
  <div class="col">
    <input id="q" placeholder="Question" required />
    <label for="startsAt">Start Time:</label>
    <input id="startsAt" type="datetime-local" required />
    <label for="endsAt">End Time:</label>
    <input id="endsAt" type="datetime-local" required />
    <input id="options" placeholder="Options (comma-separated, min 2)" required />
    <label class="row"><input id="isActive" type="checkbox" /> Active immediately</label>
    <button id="create">Create Poll</button>
  </div>

  <h2>Polls</h2>
  <div id="list" class="list"></div>

  <script>
    const $ = (id) => document.getElementById(id);
    const api = (path, method = 'GET', body) => {
      const secret = $('secret').value.trim();
      if (!secret && path.includes('/admin/')) {
        throw new Error('Admin secret is required');
      }
      const headers = { 'Content-Type': 'application/json', 'x-admin-secret': secret };
      console.log(`API ${method} ${path}`, body ? { body } : '');
      return fetch(path, { method, headers, body: body ? JSON.stringify(body) : undefined }).then(async r => {
        const contentType = r.headers.get('content-type');
        const responseText = await r.text();
        console.log(`API Response ${r.status}:`, responseText);
        
        if (!r.ok) {
          let errorMsg = `HTTP ${r.status}`;
          try {
            const errorData = JSON.parse(responseText);
            errorMsg = errorData.error || errorMsg;
          } catch (e) {
            errorMsg = responseText || errorMsg;
          }
          throw new Error(errorMsg);
        }
        
        return contentType?.includes('json') ? JSON.parse(responseText) : responseText;
      });
    };

    function renderPolls(items) {
      const container = $('list');
      container.innerHTML = '';
      for (const p of items) {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div>
              <div><strong>${p.question}</strong></div>
              <div class="muted">${p.starts_at} â†’ ${p.ends_at}</div>
              <div class="muted">Active: ${p.is_active ? 'Yes' : 'No'}</div>
              <div class="muted">ID: ${p.id}</div>
            </div>
            <div class="row">
              <button class="secondary" data-act="activate" data-id="${p.id}">Activate</button>
              <button class="secondary" data-act="deactivate" data-id="${p.id}">Deactivate</button>
            </div>
          </div>`;
        container.appendChild(el);
      }
      container.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.getAttribute('data-id');
          const act = e.target.getAttribute('data-act');
          try {
            await api(`/admin/polls/${id}/${act}`, 'POST');
            await loadPolls();
            alert('OK');
          } catch (err) { alert('Failed: ' + err.message); }
        });
      });
    }

    async function loadPolls() {
      try {
        const data = await api('/admin/polls');
        renderPolls(data.items || []);
      } catch (e) { alert('Failed to load polls: ' + e.message); }
    }

    $('load').addEventListener('click', loadPolls);
    
    $('testConnection').addEventListener('click', async () => {
      const statusEl = $('status');
      try {
        statusEl.style.display = 'block';
        statusEl.style.background = '#333';
        statusEl.textContent = 'Testing connection...';
        
        const result = await api('/admin/polls');
        statusEl.style.background = '#0d6627';
        statusEl.textContent = `Connection successful! Found ${result.items?.length || 0} polls.`;
      } catch (e) {
        statusEl.style.background = '#b42318';
        statusEl.textContent = `Connection failed: ${e.message}`;
      }
    });
    
    // Auto-fill current time for convenience
    const now = new Date();
    const nowStr = now.toISOString().slice(0, 16);
    const laterStr = new Date(now.getTime() + 60 * 60 * 1000).toISOString().slice(0, 16);
    $('startsAt').value = nowStr;
    $('endsAt').value = laterStr;

    $('create').addEventListener('click', async () => {
      const question = $('q').value.trim();
      const startsAtValue = $('startsAt').value.trim();
      const endsAtValue = $('endsAt').value.trim();
      const optionsValue = $('options').value.trim();
      const isActive = $('isActive').checked;
      
      // Basic validation
      if (!question) {
        alert('Question is required');
        return;
      }
      
      if (!startsAtValue || !endsAtValue) {
        alert('Start and end times are required');
        return;
      }
      
      if (!optionsValue) {
        alert('Options are required');
        return;
      }
      
      const options = optionsValue.split(',').map(s => s.trim()).filter(Boolean);
      if (options.length < 2) {
        alert('At least 2 options are required');
        return;
      }
      
      let startsAt, endsAt;
      try {
        startsAt = new Date(startsAtValue).toISOString();
        endsAt = new Date(endsAtValue).toISOString();
        
        // Validate dates
        if (new Date(startsAt) >= new Date(endsAt)) {
          alert('End time must be after start time');
          return;
        }
      } catch (e) {
        alert('Invalid date format');
        return;
      }
      
      try {
        console.log('Creating poll:', { question, startsAt, endsAt, isActive, options });
        const result = await api('/admin/polls', 'POST', { question, startsAt, endsAt, isActive, options });
        console.log('Poll created:', result);
        
        // Clear form
        $('q').value = '';
        $('startsAt').value = '';
        $('endsAt').value = '';
        $('options').value = '';
        $('isActive').checked = false;
        
        await loadPolls();
        alert(`Poll created successfully! ID: ${result.pollId}`);
      } catch (e) { 
        console.error('Failed to create poll:', e);
        alert('Failed to create poll: ' + e.message); 
      }
    });
  </script>
</body>
</html>
